---
layout: post
title:  분산시스템과 카오스 엔지니어링(Chaos Engineering)
date:   2021-10-07 00:00:00
categories: comm
---

## 모놀리틱과 분산시스템

전통적인 시스템은 모놀리틱 구조로 서비스가 커지면 scale-up 형태로 시스템을 확장해나갔습니다.

서비스를 하기 위해서는 실제 서버 장비를 구매하여 구축하여야 하는데, 비용이 큰 서버 장비를 여러 개 도입하는 것은 부담이 큰 일이었습니다. 이 때문에 서비스가 커져서 서버 자원이 더 필요한 경우에는 단일 서버에서(안정성을 고려한다면 이중화, 삼중화) 서버의 capacity를 늘리는 방향으로 발전해왔습니다.

모놀리틱 인프라 구조는 쉽고, 단일 관리 포인트라는 특징으로 장애시 확인해야할 범위가 특정되어 있는 장점이 있지만, 반대로 하나의 서버에서 모든 서비스를 처리하니 서버 장애시 전체 서비스가 불가하고 기술구조를 서비스 별로 분류하기 어려운 점, 서버에 올라간 서비스들이 너무 비대해질 경우 scale-up의 한계로 성능을 충분히 내지 못하는 등의 단점이 있습니다.

모바일 시장이 발달하며 웹서비스들은 과거에 비해 더 많은 일들을 처리하고 다양한 형태의 서비스를 하게 되었습니다. 이에따라 웹서버는 더 많은 처리를 안정적으로 하고 서비스를 계속해서 업데이트하여 배포해야하게 되었습니다.

AWS, Google Cloud와 같은 클라우드 인프라 서비스의 탄생은 모놀리틱으로 할 수 밖에 없었던 다양한 제약 들을 해소하며 기업들에게 분산시스템을 구축할 수 있는 환경을 제공해주었습니다. 클라우드를 이용하면 서버 장비의 구매, 유지보수, 리스크 관리에 대한 부담감을 클라우드 업체에 덜고, 요건에 따라 클라우드 자원을 이용하여 웹 서비스를 구축할 수 있습니다.

분산시스템 구조에서는 모듈화 할 수 있는 단위의 작은 서비스 서비스들을 별도의 서버 자원에 할당합니다. 이는 서비스 간 결합을 최소화하여 변화에 유연하게 하고 장애시 타 서비스로의 영향도를 감소시킵니다.

 하지만 분산시스템이 대규모로 커져 많은 서비스가 개별적으로 돌아가고 다양하게 상호작용하게 되어버려 관리포인트가 일정 수준을 넘어서면 장애시 장애포인트를 찾기 어려워지고 신속한 대처가 어려워집니다. 

카오스 엔지니어링은 바로 이를 대비하기 위한 기법입니다.



## 카오스 엔지니어링 

**카오스 엔지니어링**이란 복잡한 분산 시스템 환경에서 시스템의 신뢰성을 확인하기 위해, 인위적인 혼돈(Chaos)을 가하여 시스템의 취약한 부분을 찾고 보강하는 방식의 엔지니어링 기법입니다.

분산 시스템 환경에서 특정 인스턴스에 과도한 부하 혹은 예기치 못한 중단 등의 상황이 발생하였을때 다른 시스템들이 어떻게 영향을 받는 지를 테스트하고 이를 적절히 대처해봄으로서 분산 시스템의 불확실성을 해소하기 위한 방안으로 주목받고 있습니다.

경험이 뒷받침된 시스템 접근 방식은 대규모 분산 시스템에서의 혼란을 해결하고 이러한 시스템이 실제 환경에서의 변수에도 견딜 수 있다는 확신을 심어줍니다. 



### 카오스 테스트 원칙

- ### 정상 상태와 동작에 관한 가설을 세운다

  시스템의 내부 속성보다는 측정 가능한 시스템 결과물에 중점을 두어야 합니다. 짧은 시간 동안 측정한 결과물들은 시스템의 정상 상태를 대변합니다. 전반적인 시스템 처리량, 에러율, 지연 백분위 수 등은 모두 정상 상태를 나타내는 주요 지표일 수 있습니다. 실험할 때는 시스템의 행동 패턴에 집중합니다. 그러면 카오스는 시스템이 어떻게 작동하는지가 아닌 시스템이 정상적으로 작동하는지를 검증합니다.

- ### 다양한 실제 이벤트 변수들을 적용한다

  카오스에서의 변수는 실제 이벤트를 반영합니다. 잠재적 영향력 또는 예상 빈도에 따라 이벤트의 우선 순위를 지정합니다. 서버 중단과 같은 하드웨어 장애, 잘못된 응답과 같은 소프트웨어 장애, 트래픽 급증 또는 시스템 확장과 같은 비장애 이벤트와 같은 이벤트들을 고려해야 합니다. 정상 상태를 방해할 수 있는 모든 이벤트는 카오스 실험에서 잠재적인 변수입니다.

- ### 운영 환경에서 실험을 진행한다

  시스템은 환경 및 트래픽 패턴에 따라 다르게 동작합니다. 사용률 패턴은 언제든지 변경될 수 있기 때문에, 실제 트래픽을 샘플링하는 것이 요청 경로를 안정적으로 캡처하는 유일한 방법입니다. 시스템 실행 방식에 대한 신뢰성과 현재 배포된 시스템과의 관련성을 보장하기 위해, 카오스는 운영 환경의 트래픽에서 직접 실험하는 것을 선호합니다.

- ### 자동화를 통해 지속적으로 실험을 진행한다

  수동으로 실험을 진행하게 되면 공수가 많이 들어갈 뿐만 아니라 궁극적으로 지속 불가능합니다. 실험을 자동화하고 지속적으로 실행해야 합니다. 카오스 엔지니어링은 오케스트레이션과 분석을 모두 추진하기 위해 시스템 내에 자동화를 구축하는 것입니다.

- ### 위험범위를 최소화한다

  운영 환경에서의 실험은 고객에게 불필요한 불편을 야기할 수 있습니다. 짧은 시간동안 발생하는 부정적 영향에 대해서는 어느 정도 허용되어야 하지만, 실험으로 인해 여러 시스템에 발생할 수 있는 큰 피해를 최소화하고 억제하는 것은 카오스 엔지니어의 책임이자 의무입니다.

  카오스 엔지니어링은 이미 소프트웨어 설계와 엔지니어링 방식을 바꾼 강력한 도구이며, 이는 전세계에서 가장 큰 규모의 작업들에서 이루어지고 있습니다. 다른 방식들이 속도와 유연성을 다루는 반면, Chaos는 주로 이러한 분산 시스템의 불확실성을 다룹니다. 이 카오스의 원칙들은 대규모로 신속하게 혁신할 수 있는 자신감을 제공하고, 나아가 고객에게 가치있는 고품질 경험을 제공합니다.



### 카오스 몽키

카오스 엔지니어링은 넷플릭스가 IDC 환경에서 AWS로 인프라를 이전할때 처음 도출된 개념입니다. 넷플릭스가 카오스 엔지니어링의 툴로 개발한 오픈소스 라이브러리가 **카오스 몽키**입니다. 

카오스 몽키는 원숭이가 시스템실에 침입하여 무작위로 시스템들을 조작하고 파괴하는 상황을 빗대어 표현한 용어로, 운영환경에서 서비스 인스턴스들을 무작위로 중단시키고 관찰하는 것을 지원합니다.

[넷플릭스 카오스 몽키 블로그](https://netflix.github.io/chaosmonkey/)



[참고]

[itwiki - chaos engineering](https://itwiki.kr/w/%EC%B9%B4%EC%98%A4%EC%8A%A4_%EC%97%94%EC%A7%80%EB%8B%88%EC%96%B4%EB%A7%81)

[principlesofchaos](https://principlesofchaos.org/ko/)

